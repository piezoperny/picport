{{ define "main" }}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Map Container */
    #map {
        height: 85vh;
        width: 100%;
        background: #111;
        z-index: 1;
    }
    
    /* Dark Theme Popup Styles */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
        background: #222;
        color: #eee;
        border: 1px solid #444;
    }
    .leaflet-popup-content {
        margin: 10px;
        text-align: center;
    }
    .popup-thumb {
        width: 100%;
        max-width: 200px;
        height: auto;
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 2px;
    }
</style>

<div id="map"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialize Map (Centered on Europe by default)
    const map = L.map('map').setView([46.0, 10.0], 4);

    // 2. Add Dark Mode Tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // 3. Fetch Data & Parse Filenames
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            let markersCount = 0;
            
            data.forEach(img => {
                // Name Format: 
                // DATE_TIME-CAM_ISO_AP_SS--LAT_LON.jpg
                
                // A. Split by the double dash "--"
                const parts = img.name.split('--');
                
                // Ensure we actually have coordinates (length > 1)
                if (parts.length > 1) {
                    // B. Get the last part: "LAT_LON.jpg" (or .JPG)
                    let coordsRaw = parts[parts.length - 1];
                    
                    // C. Remove extension (Case Insensitive)
                    coordsRaw = coordsRaw.replace(/\.(jpg|jpeg|png|webp|gif)$/i, "");
                    
                    // D. Split by underscore to get Lat and Lon
                    const latLon = coordsRaw.split('_');
                    
                    if (latLon.length >= 2) {
                        const lat = parseFloat(latLon[0]);
                        const lon = parseFloat(latLon[1]);

                        // E. Verify they are valid numbers
                        if (!isNaN(lat) && !isNaN(lon)) {
                            // Create Marker
                            const marker = L.marker([lat, lon]).addTo(map);
                            markersCount++;

                            // Bind Popup (Image + Click to Lightbox)
                            const popupHtml = `
                                <div>
                                    <img src="${img.url}" class="popup-thumb" onclick="openLightbox('${img.url}')">
                                </div>
                            `;
                            marker.bindPopup(popupHtml);
                        }
                    }
                }
            });
            console.log(`Map loaded with ${markersCount} locations.`);
        })
        .catch(err => console.error("Error loading map data:", err));
});
</script>

{{ end }}
