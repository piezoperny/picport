{{ define "main" }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<style>
    #map { height: 85vh; width: 100%; background: #111; z-index: 1; }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #222; color: #eee; border: 1px solid #444; }
    .leaflet-popup-content { margin: 10px; text-align: center; }
    .popup-thumb { width: 100%; max-width: 200px; height: auto; display: block; margin-bottom: 8px; cursor: pointer; border-radius: 2px; }
</style>

<div id="map"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('map').setView([46.0, 10.0], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OSM & CARTO',
        maxZoom: 19
    }).addTo(map);

    const markers = L.markerClusterGroup();

    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            data.forEach(img => {
                const parts = img.name.split('--');
                if (parts.length > 1) {
                    let coordsRaw = parts[parts.length - 1].replace(/\.(jpg|jpeg|png|webp|gif)$/i, "");
                    const latLon = coordsRaw.split('_');
                    if (latLon.length >= 2) {
                        const lat = parseFloat(latLon[0]);
                        const lon = parseFloat(latLon[1]);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            const marker = L.marker([lat, lon]);
                            const popupHtml = `<div><img src="${img.url}" class="popup-thumb" onclick="openLightbox('${img.url}')"></div>`;
                            marker.bindPopup(popupHtml);
                            markers.addLayer(marker);
                        }
                    }
                }
            });
            map.addLayer(markers);
        });
});
</script>
{{ end }}
